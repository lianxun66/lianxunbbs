<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>链讯-去中心化论坛</title>
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="keywords" content="链讯,去中心化论坛,DAPP论坛,区块链新生态">
<meta name="description" content="去中心化论坛,DAPP论坛,区块链新生态">
<link rel="icon" href="/favicon.ico" type="image/x-icon" />
<link rel="stylesheet" href="/res/layui/css/layui.css">
<link rel="stylesheet" href="/res/css/global.css">
<style>
.layui-col-md8 {
    width: 100%;
}
</style></head>

<body>
<div class="fly-header layui-bg-black">
  <div class="layui-container">
    <a class="fly-logo" href="/index.html">
      <img src="/res/images/logo.png" alt="layui">
    </a>
    <ul class="layui-nav fly-nav layui-hide-xs">
      <li class="layui-nav-item layui-this">
        <a href="/"><i class="iconfont icon-jiaoliu"></i>交流</a>
      </li>
    </ul>
    <ul class="layui-nav fly-nav-user" id="login">
       <li class="layui-nav-item">
          <a href="/user/login.html">登入</a>
        </li>
        <li class="layui-nav-item">
          <a href="/user/reg.html">注册</a>
        </li>
 <script id="userInfo" type="text/html">
      <!-- 登入后的状态 -->
      <li class="layui-nav-item " >
        <a class="fly-nav-avatar" href="/user/set.html">
          <cite class="layui-hide-xs">{{toNickname(nickname)}}</cite>
          <img src="{{toIcon(icon,timestamp)}}">
        </a>
        <dl class="layui-nav-child layui-anim layui-anim-upbit" id="loginitem">
          <dd><a href="/user/set.html"><i class="layui-icon">&#xe620;</i>基本设置</a></dd>
			<hr style="margin: 5px 0;">
          <dd><a href="javascript:;" style="text-align: center;" onclick="exit()">退出</a></dd>
        </dl>
      </li>
</script>
    </ul>
  </div>
</div><div class="fly-panel fly-column">
  <div class="layui-container">
    <ul class="layui-clear">
      <li class="layui-hide-xs layui-this"><a href="/index.html">首页<span class="layui-badge-dot"></span></a></li> 
      <!-- 用户登入后显示 -->
    </ul> 
    
    <div class="fly-column-right layui-hide-xs"> 
      <a href="/note/add.html" class="layui-btn">发表新帖</a> 
    </div> 
    <div class="layui-hide-sm layui-show-xs-block" style="margin-top: -10px; padding-bottom: 10px; text-align: center;"> 
      <a href="/note/add.html" class="layui-btn">发表新帖</a> 
    </div> 
  </div>
</div>
<div class="layui-container">
  <div class="layui-row layui-col-space15">
    <div class="layui-col-md8 content detail">
      <div class="fly-panel detail-box" id="noteDetail">
      	<script id="note" type="text/html">
        <h1>{{title}}</h1>
        <div class="fly-detail-info">
          <span class="layui-badge layui-bg-green fly-detail-column">{{column}}</span>
          <span class="fly-list-nums"> 
            <a href="#comment"><i class="iconfont" title="回答">&#xe60c;</i>{{commentcount}}</a>
          </span>
        </div>
        <div class="detail-about">
          <a class="fly-avatar" href="javascript:;">
            <img src="{{toIcon(icon,noteId)}}" alt="{{toNickname(nickname)}}">
          </a>
          <div class="fly-detail-user">
            <a href="javascript:;" class="fly-link">
              <cite>{{toNickname(nickname)}}</cite>
            </a>
          </div>
          <div class="detail-hits" id="LAY_jieAdmin" data-id="{{noteId}}">
            <span>{{toTimeAgo(timestamp)}}</span>  
          </div>
        </div>
        <div class="detail-body photos">
         {{content}}
        </div>
        </script>
      </div>

      <div class="fly-panel detail-box" id="flyReply">
        <fieldset class="layui-elem-field layui-field-title" style="text-align: center;">
          <legend>回帖</legend>
        </fieldset>

        <ul class="jieda" id="jieda" >
        	<script id="comments" type="text/html">
{{if comments.length>0}}
{{each comments as comment}}
          <li class="jieda-daan">
            <a name="item"></a>
            <div class="detail-about detail-about-reply">
              <a class="fly-avatar" href="javascript:;">
                <img src="{{toIcon(comment.icon,comment.timestamp)}}" alt="{{toNickname(comment.nickname)}} ">
              </a>
              <div class="fly-detail-user">
                <a href="javascript:;" class="fly-link">
                  <cite>{{toNickname(comment.nickname)}}</cite>
                </a>
              </div>

              <div class="detail-hits">
                <span>{{toTimeAgo(comment.timestamp)}}</span>
              </div>
            </div>
			<div class="detail-body layui-text jieda-body photos">
			{{comment.content}}
			 </div>
            <div class="jieda-reply">
              <span type="reply">
                <i class="iconfont icon-svgmoban53"></i>
                回复
              </span>
            </div>
          </li>
{{/each}}
{{else}}
 <li class="fly-none">消灭零回复</li> 
{{/if}}
          </script>
          <!-- 无数据时 -->
          <!-- <li class="fly-none">消灭零回复</li> -->
        </ul>
        <div style="text-align: center">
						<div class="boxTools clearfix">
							<div id="pageList"></div>
						</div>
					</div>
        <div class="layui-form layui-form-pane">
          <form action="" method="post">
            <div class="layui-form-item layui-form-text">
              <a name="comment"></a>
              <div class="layui-input-block">
                <textarea id="L_content" name="content" required lay-verify="required" placeholder="请输入内容"  class="layui-textarea fly-editor" style="height: 150px;"></textarea>
              </div>
            </div>
            <div class="layui-form-item">
              <input type="hidden" name="jid" >
              <button class="layui-btn" lay-filter="*" lay-submit id="subComment">提交回复</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    </div>
  </div>
</div>

<div class="fly-footer">
  <p><a href="javascript:;" target="_blank">链讯DAPP社区</a> 2018 &copy; <a href="javascript:;" target="_blank">链讯 出品</a></p>
</div>

<script src="/res/layui/layui.js"></script>
<script type="text/javascript" src="/dist/nebulas.js"></script>
<script type="text/javascript" src="/js/template.js"></script>
<script type="text/javascript" src="/js/jquery.min63b9.js"></script>
<script type="text/javascript" src="/js/common.js"></script>
<script>
layui.cache.page = '';
layui.cache.user = {
  username: '游客'
  ,uid: -1
  ,avatar: '../res/images/avatar/00.jpg'
  ,experience: 83
  ,sex: '男'
};
layui.config({
	  version: "3.0.0"
	  ,base: '/res/mods/'  //这里实际使用时，建议改成绝对路径
	}).extend({
	  fly: 'index'
	}).use('fly');
	var icon="";
	var nickname="";
	template.helper('toIcon', function (icon,noteId){
		  if(!icon){
			  if(noteId){
			  	icon="/res/images/avatar/"+noteId%10+".jpg";
			  }else{
				  icon="/res/images/avatar/0.jpg";
			  }
		  }
		  return icon;
	  });
	template.helper('toNickname',function (nickname){
		  if(!nickname){
			  nickname="匿名用户";
		  }
		  return nickname;
	  });
	var layuishowId;
$(function(){
	  if(localStorage.getItem("privateKey")){
		 account=new Account(localStorage.getItem("privateKey"));
		 var args=new Array();
		 args[0]=account.getAddressString();
		 readNas(PersonAddress, "get",JSON.stringify(args),function(data){
		 var result=JSON.parse(data.result);
		 if(result){
			 icon=result.icon;
			 nickname=result.nickname;
		 }
	
		 var html = template('userInfo',result); 
		 $('#login').html(html); 
		 $('#login').hover(function(){
			 $('#loginitem').addClass("layui-show");
		 },function(){
			 layuishowId= setTimeout(function(){
				 $('#loginitem').removeClass("layui-show");
			 },1000);
		 });
		 sleepUser(result);
		 $('#loginitem').hover(function(){
			 if(layuishowId){
				 clearTimeout(layuishowId);
			 }
			 $('#loginitem').addClass("layui-show");
		 },function(){
			 $('#loginitem').removeClass("layui-show");
		 });
		 });
	   }
});
function sleepUser(user){
	var edithtmlInfo=$("#edithtmlInfo");
	$("#address").text(account.getAddressString());
		if(edithtmlInfo[0]&&user){
			$("#L_mobile").val(user.mobile);
			$("#L_email").val(user.email);
			$("#L_username").val(user.nickname);
			$("#L_city").val(user.city);
			$("#L_sign").val(user.info);
		    $("input[name='sex']:eq("+user.sex+")").next().click();
		    $("#editimguser").attr("src",user.icon?user.icon:"/res/images/avatar/"+user.timestamp%10+".jpg");
		}
}
</script><script type="text/javascript">
$(function(){
	var noteId=getQueryString("noteId");
	var pageNumber=getQueryString("pageNumber");
	if (!pageNumber)pageNumber=1;
	template.helper('toTimeAgo', function  (dateTimeStamp){
		var minute = 1000 * 60;
		var hour = minute * 60;
		var day = hour * 24;
		var halfamonth = day * 15;
		var month = day * 30;
		var now = new Date().getTime();
		var diffValue = now - dateTimeStamp;
		var monthC =diffValue/month;
		var weekC =diffValue/(7*day);
		var dayC =diffValue/day;
		var hourC =diffValue/hour;
		var minC =diffValue/minute;
		if(monthC>=1){
			result="" + parseInt(monthC) + "月前";
		}
		else if(weekC>=1){
			result="" + parseInt(weekC) + "周前";
		}
		else if(dayC>=1){
			result=""+ parseInt(dayC) +"天前";
		}
		else if(hourC>=1){
			result=""+ parseInt(hourC) +"小时前";
		}
		else if(minC>=1){
			result=""+ parseInt(minC) +"分钟前";
		}else
		result="刚刚";
		return result;
	});
	template.helper('toIcon', function (icon,noteId){
		if(!icon){
			  if(noteId){
			  	icon="/res/images/avatar/"+noteId%10+".jpg";
			  }else{
				  icon="/res/images/avatar/0.jpg";
			  }
		  }
		  return icon;
	  });
	template.helper('toNickname',function (nickname){
		  if(!nickname){
			  nickname="匿名用户";
		  }
		  return nickname;
	  });
	readNas(BBSAddress, "getNote",'['+noteId+','+pageNumber+',10]',function(data){
		 var result=JSON.parse(data.result);
		 var html = template('note',result.note); 
		 $('#noteDetail').html(html); 
		 var commentHtml = template('comments',result); 
		 $('#jieda').html(commentHtml); 
		 $('.detail-body').each(function(){
			    var othis = $(this), html = othis.html();
			    othis.html(fly.content(html));
			  });
		  $('.jieda-reply span').on('click', function(){
			    var othis = $(this), type = othis.attr('type');
			    var li=othis.parents('li');
			    var content=$("#L_content");
			    var val = content.val();
			      var aite = '@'+ li.find('.fly-detail-user cite').text().replace(/\s/g, '');
			      content.focus()
			      if(val.indexOf(aite) !== -1) return;
			      content.val(aite +' ' + val);
			  });
		  if(result.commentTotal>20){
			  layui.use('laypage', function(){
				  var laypage = layui.laypage;
				  //执行一个laypage实例
				  laypage.render({
				    elem: 'pageList' //注意，这里的 test1 是 ID，不用加 # 号
				    ,count: result.commentTotal //数据总数，从服务端得到
				    ,curr:pageNumber
				    ,limit:10
				    ,jump : function(obj, first) {
						//obj包含了当前分页的所有参数，比如：
						//首次不执行
						if (!first) {
							location.href="/note/detail.html?noteId="+noteId+"&pageNumber="+obj.curr;
						}
					}
				  });
				});
		  }
		 
	});
	$("#subComment").click(function(){
		var content=$("#L_content").val()+"";
		var args=new Array();
		args[0]=noteId;
		args[1]=content;
		args[2]=icon;
		args[3]=nickname;
		sendNas(BBSAddress, "comment",JSON.stringify(args),function(data){
			 var txhash = data.txhash;
			 layer.msg("提交成功，请等待区块确认");
			 $("#L_content").val("");
			 window.scrollBy(0,-10); 
			 $(window).scrollTop(0);
		});
		return false;
	});
});

</script>

</body>
</html>